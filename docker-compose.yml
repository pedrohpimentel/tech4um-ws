version: '3.8'

# Este arquivo define os serviços que compõem sua aplicação:
# 1. Banco de Dados (mysql_db)
# 2. Aplicação Spring Boot (app)
services:
  # ====================================================================
  # 1. SERVIÇO DE BANCO DE DADOS (MySQL)
  # ====================================================================
  mysql_db:
    image: mysql:8.0
    container_name: project_ws_mysql
    # Variáveis de ambiente que configuram o MySQL.
    # AJUSTE AS CREDENCIAIS DE ACORDO COM SEU PROJETO!
    environment:
      MYSQL_ROOT_PASSWORD: root_password # Senha do root (admin)
      MYSQL_DATABASE: project_ws_db      # Nome do banco de dados
      MYSQL_USER: user                   # Usuário da aplicação
      MYSQL_PASSWORD: password           # Senha da aplicação
    ports:
      # Mapeia a porta padrão do MySQL (3306) do container para sua máquina
      - "3307:3306"
    volumes:
      # Persistência de dados: garante que os dados não se percam quando o container for parado.
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====================================================================
  # 2. SERVIÇO DA APLICAÇÃO SPRING BOOT
  # ====================================================================
  app:
    build:
      context: . # Indica que o Dockerfile está neste diretório (raiz do projeto)
    container_name: project_ws_app
    ports:
      - "8080:8080"
    environment:
      # Ativa o perfil de desenvolvimento no Spring Boot
      SPRING_PROFILES_ACTIVE: dev

      # URL de conexão: o hostname AGORA é o nome do serviço (mysql_db), não 'localhost'
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql_db:3306/project_ws_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password
    # Garante que o banco de dados esteja funcionando antes de tentar iniciar a aplicação
    depends_on:
      mysql_db:
        condition: service_healthy

# Define os volumes para persistência de dados
volumes:
  mysql_data: